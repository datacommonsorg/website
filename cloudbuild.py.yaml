# Run Python tests, lint, etc.
steps:

- id: flask_test
  name: python:3.7-slim
  entrypoint: /bin/sh
  args:
  - -c
  - ./run_test.sh -p

- id: flask_webdriver_test
  name: python:3.7-slim
  entrypoint: /bin/sh
  args:
  - -c
  - |
    set -e
    apt-get update
    apt-get upgrade
    apt-get install -y unzip xvfb libxi6 libgconf-2-4
    apt-get install -y wget
    wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
    dpkg -i google-chrome-stable_current_amd64.deb; apt-get -fy install
    wget https://chromedriver.storage.googleapis.com/84.0.4147.30/chromedriver_linux64.zip
    unzip chromedriver_linux64.zip
    mv chromedriver /usr/bin/chromedriver
    chown root:root /usr/bin/chromedriver
    chmod +x /usr/bin/chromedriver
    cd server
    export FLASK_ENV=development
    export GOOGLE_CLOUD_PROJECT=datcom-browser-staging
    pip3 install -r requirements.txt -q
    python3 -m pytest webdriver_tests/**.py
    cd ..
  # - ./run_test.sh -w

- id: pv_tree_generator
  name: python:3.7-slim
  entrypoint: /bin/sh
  args:
  - -c
  - 'cd tools/pv_tree_generator && pip install -r requirements.txt && python -m pytest'

# TODO: Add Python linter, format checker, and any other useful code health tools.