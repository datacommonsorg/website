# Golden Curation

This folder contains resources and scripts for curating the goldens for nl
detection evals. These are for auto-curating the goldens that then need to go
through manual checks.

## Generate Vars

This auto-curates a list of variable dcids (including all the variables in the
Data Commons knowledge graph) that match a given query. The list of variables will be their dcid unless the variable is under a topic. For variables under a topic, the number of --> preceding the variable will show its depth within the topic hierarchy. See example [input file](./example_input/var_example.csv) [output file](./example_output/var_example_vars.csv)

### Prerequisites

1. In your input folder, you need to have your CSV files with the following columns (there can be multiple rows for the same query if there is disagreement on what the variable string for the query is)
    - query_num: This is a unique number for each query
    - query: This is the full query string
    - var_string: This is the substring of the query that should be used to
    detect the variable in the query
    - groups: These are the groups that the variable in the query could belong to. The variable could belong to multiple groups and these groups should be comma separated. Each group should be one of the keys in [this dict](https://github.com/datacommonsorg/website/blob/master/tools/nl/detection_evals/golden_curation/generate_vars.py#L38-L49).
2. Start a local server with additional embedding indices enabled for all the variable groups where the index name should match the values in [this dict](https://github.com/datacommonsorg/website/blob/master/tools/nl/detection_evals/golden_curation/generate_vars.py#L38-L49).
    - you can copy the indices defined and enabled here ([catalog.yaml](https://github.com/chejennifer/website/blob/nlGoldensEmbeddings/deploy/nl/catalog.yaml#L96-L155), [autopush.yaml](https://github.com/chejennifer/website/blob/nlGoldensEmbeddings/deploy/helm_charts/envs/autopush.yaml#L65-L74)). These were generated by getting a json of the svg cache following these [instructions](https://g3doc.corp.google.com/datacommons/prophet/tools/README.md#refreshing-statvargroup-cache) and then extracting the dcid and names of the variables to use to [build_embeddings](../../embeddings/README.md#build-embeddings-index).
    - Or you can extract variable names and dcids using any other method and use that to [build_embeddings](../../embeddings/README.md#build-embeddings-index).
    - After updating the catalog.yaml and autopush.yaml locally, start the server by running `./run_server.sh -m`
3. A copy of the [topic_cache.json](../../../../server/config/nl_page/topic_cache.json) file

### Run

```./run.sh vars [--input_folder=] [--output_folder=] [--topic_cache=]```

## Generate StatVarGroups (SVGs)

This auto-curates a list of svg dcids that match a given query. To show the hierarchy of svgs, the number of --> preceding the svg will show its depth within the svg hierarchy. See example [input file](./example_input/svg_example.csv) [output file](./example_output/svg_example_svgs.csv)

### Prerequisites

1. In your input folder, you need to have your CSV files with the following columns (there can be multiple rows for the same query and variable string, one row per matching variable). You can also just directly use the output from Generate Vars.
    - query_num: This is a unique number for each query
    - query: This is the full query string
    - var_string: This is the substring of the query that should be used to
    detect the variable in the query
    - var: This is the dcid of a variable that matches the variable string. This can have "-->" which will be cleaned up in the script.
2. Start a local server with an additional embedding index enabled for svgs. This index should match the name [here](https://github.com/datacommonsorg/website/blob/master/tools/nl/detection_evals/golden_curation/generate_svgs.py#L26).
    - you can copy the index defined and enabled here ([catalog.yaml](https://github.com/chejennifer/website/blob/nlGoldensEmbeddings/deploy/nl/catalog.yaml#L156-L161), [autopush.yaml](https://github.com/chejennifer/website/blob/nlGoldensEmbeddings/deploy/helm_charts/envs/autopush.yaml#L75)). The names and dcids of StatVarGroups were extracted by running this [SQL query](https://paste.googleplex.com/6470327684825088) in BigQuery and then using the output to [build_embeddings](../../embeddings/README.md#build-embeddings-index).
    - Or you can extract variable names and dcids using any other method and use that to [build_embeddings](../../embeddings/README.md#build-embeddings-index).
    - After updating the catalog.yaml and autopush.yaml locally, start the server by running `./run_server.sh -m`
3. A copy of svg_cache.json which can be generated following these [instructions](https://g3doc.corp.google.com/datacommons/prophet/tools/README.md#refreshing-statvargroup-cache). [Example svg_cache.json](https://cnsviewer.corp.google.com/cns/jv-d/home/datcom/tmp/svg_2021_0405_1130.json?user=knowledge-answers).

### Run

```./run.sh svgs [--input_folder=] [--output_folder=] [--svg_cache=]```


